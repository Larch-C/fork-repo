name: Sync All AstrBot Plugins

on:
  workflow_dispatch:          # æ‰‹åŠ¨è§¦å‘
    inputs:
      dry_run:
        description: 'è¯•è¿è¡Œæ¨¡å¼ï¼ˆä»…æ˜¾ç¤ºæ“ä½œï¼Œä¸å®é™…æ‰§è¡Œï¼‰'
        required: false
        default: false
        type: boolean
      force_sync:
        description: 'å¼ºåˆ¶åŒæ­¥æ‰€æœ‰å·²forkçš„ä»“åº“'
        required: false
        default: false
        type: boolean
  schedule:                   # æ¯å°æ—¶ UTC è‡ªåŠ¨åŒæ­¥
    - cron: "0 * * * *"

env:
  PLUGIN_JSON_URL: "https://raw.githubusercontent.com/AstrBotDevs/AstrBot_Plugins_Collection/main/plugins.json"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      repos: ${{ steps.list.outputs.repos }}
      total_count: ${{ steps.list.outputs.total_count }}
    steps:
      - name: Fetch plugins.json
        run: |
          echo "ğŸ“¥ æ­£åœ¨è·å– plugins.json..."
          curl -fsSL "$PLUGIN_JSON_URL" -o plugins.json
          echo "âœ… plugins.json è·å–å®Œæˆ"
          
      - name: Parse repo list
        id: list
        run: |
          echo "ğŸ“‹ æ­£åœ¨è§£æä»“åº“åˆ—è¡¨..."
          
          # æå–æ‰€æœ‰ä»“åº“URLå¹¶æ¸…ç†æ ¼å¼
          repos=$(jq -r '
            to_entries[] | 
            select(.value.repo != null) | 
            .value.repo
          ' plugins.json | \
          sed 's|git@github.com:|https://github.com/|' | \
          sed 's|\.git$||' | \
          sed 's|/tree/.*||' | \
          sed 's|/blob/.*||' | \
          grep -E '^https://github\.com/[^/]+/[^/]+$' | \
          sort -u)
          
          # è½¬æ¢ä¸ºJSONæ•°ç»„æ ¼å¼
          repo_array=$(echo "$repos" | jq -R -s -c 'split("\n") | map(select(. != ""))')
          total_count=$(echo "$repos" | wc -l)
          
          echo "repos=$repo_array" >> $GITHUB_OUTPUT
          echo "total_count=$total_count" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š æ‰¾åˆ° $total_count ä¸ªæœ‰æ•ˆçš„GitHubä»“åº“ï¼š"
          echo "$repos" | head -10
          if [ $total_count -gt 10 ]; then
            echo "... å’Œå…¶ä»– $((total_count - 10)) ä¸ªä»“åº“"
          fi

  create-batches:
    runs-on: ubuntu-latest
    needs: prepare
    if: needs.prepare.outputs.total_count > 0
    outputs:
      batches: ${{ steps.batch.outputs.batches }}
      batch_count: ${{ steps.batch.outputs.batch_count }}
    steps:
      - name: Create batches
        id: batch
        run: |
          echo "ğŸ“¦ æ­£åœ¨åˆ›å»ºæ‰¹æ¬¡..."
          
          # è¯»å–ä»“åº“åˆ—è¡¨
          repos='${{ needs.prepare.outputs.repos }}'
          total_count=${{ needs.prepare.outputs.total_count }}
          
          # æ¯æ‰¹å¤„ç†30ä¸ªä»“åº“ï¼ˆå‡å°‘æ‰¹æ¬¡å¤§å°ï¼‰
          batch_size=30
          batch_count=$(( (total_count + batch_size - 1) / batch_size ))
          
          echo "æ€»ä»“åº“æ•°: $total_count"
          echo "æ‰¹æ¬¡å¤§å°: $batch_size"
          echo "æ‰¹æ¬¡æ•°é‡: $batch_count"
          
          # åˆ›å»ºæ‰¹æ¬¡æ•°ç»„
          batches="["
          for i in $(seq 0 $((batch_count - 1))); do
            start_idx=$((i * batch_size))
            end_idx=$(((i + 1) * batch_size))
            
            # ä½¿ç”¨jqæå–å½“å‰æ‰¹æ¬¡çš„ä»“åº“
            batch_repos=$(echo "$repos" | jq -c ".[$start_idx:$end_idx]")
            
            if [ $i -gt 0 ]; then
              batches="$batches,"
            fi
            batches="$batches{\"batch_id\":$i,\"repos\":$batch_repos}"
          done
          batches="$batches]"
          
          echo "batches=$batches" >> $GITHUB_OUTPUT
          echo "batch_count=$batch_count" >> $GITHUB_OUTPUT
          
          echo "âœ… åˆ›å»ºäº† $batch_count ä¸ªæ‰¹æ¬¡"

  fork-sync:
    runs-on: ubuntu-latest
    needs: [prepare, create-batches]
    if: needs.create-batches.outputs.batch_count > 0
    strategy:
      max-parallel: 2           # è¿›ä¸€æ­¥é™ä½å¹¶å‘æ•°
      fail-fast: false         # æŸä¸ªæ‰¹æ¬¡å¤±è´¥ä¸å½±å“å…¶ä»–æ‰¹æ¬¡
      matrix:
        batch: ${{ fromJson(needs.create-batches.outputs.batches) }}

    steps:
      - name: Setup environment
        run: |
          echo "BATCH_ID=${{ matrix.batch.batch_id }}" >> $GITHUB_ENV
          echo "ğŸ“¦ å¤„ç†æ‰¹æ¬¡ ${{ matrix.batch.batch_id }}"
          
      - name: Setup GH CLI
        run: |
          # æ£€æŸ¥æ˜¯å¦æœ‰GH_PATï¼Œå¦‚æœæ²¡æœ‰åˆ™æç¤ºç”¨æˆ·
          if [ -z "${{ secrets.GH_PAT }}" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° GH_PAT secret"
            echo "è¯·æŒ‰ç…§ä»¥ä¸‹æ­¥éª¤è®¾ç½®Personal Access Token:"
            echo "1. è®¿é—® GitHub Settings â†’ Developer settings â†’ Personal access tokens"
            echo "2. åˆ›å»ºæ–°tokenï¼Œéœ€è¦ repo å’Œ workflow æƒé™"
            echo "3. åœ¨ä»“åº“è®¾ç½®ä¸­æ·»åŠ åä¸º GH_PAT çš„secret"
            exit 1
          fi
          echo "${{ secrets.GH_PAT }}" | gh auth login --with-token
          
      - name: Verify authentication
        run: |
          echo "ğŸ” éªŒè¯GitHubè®¤è¯..."
          gh auth status
          echo "âœ… è®¤è¯æˆåŠŸ"
          
      - name: Batch delay (Rate limiting protection)
        if: ${{ matrix.batch.batch_id != 0 }}
        run: |
          # æ¯ä¸ªæ‰¹æ¬¡ä¹‹é—´å»¶è¿Ÿï¼Œé¿å…rate limit
          delay_seconds=$(( ${{ matrix.batch.batch_id }} * 15 ))
          echo "â±ï¸  æ‰¹æ¬¡ ${{ matrix.batch.batch_id }} å»¶è¿Ÿ ${delay_seconds} ç§’..."
          sleep $delay_seconds
          
      - name: Process batch repositories
        run: |
          echo "ğŸ”„ å¼€å§‹å¤„ç†æ‰¹æ¬¡ ${{ matrix.batch.batch_id }} çš„ä»“åº“..."
          
          # åˆ›å»ºç»“æœç›®å½•
          mkdir -p results
          
          # å¤„ç†å½“å‰æ‰¹æ¬¡çš„æ‰€æœ‰ä»“åº“
          repos='${{ toJson(matrix.batch.repos) }}'
          
          # è®¾ç½®é”™è¯¯å¤„ç†
          set +e  # å…è®¸å‘½ä»¤å¤±è´¥è€Œä¸é€€å‡ºè„šæœ¬
          
          # åˆå§‹åŒ–è®¡æ•°å™¨
          processed=0
          total_in_batch=$(echo "$repos" | jq -r 'length')
          
          echo "$repos" | jq -r '.[]' | while read -r repo_url; do
            processed=$((processed + 1))
            echo "ğŸ“¦ å¤„ç†ä»“åº“ ($processed/$total_in_batch): $repo_url"
            
            # é‡ç½®é”™è¯¯æ ‡å¿—
            error_occurred=false
            status="unknown"
            message="å¤„ç†ä¸­..."
            
            # æå–ä»“åº“ä¿¡æ¯
            owner_repo=${repo_url#*github.com/}
            owner_repo=${owner_repo%/}
            owner=$(echo "$owner_repo" | cut -d/ -f1)
            repo=$(echo "$owner_repo" | cut -d/ -f2)
            
            # æ·»åŠ è¶…æ—¶å’Œé‡è¯•æœºåˆ¶
            retry_count=0
            max_retries=3
            
            while [ $retry_count -lt $max_retries ]; do
              echo "ğŸ”„ å°è¯• $((retry_count + 1))/$max_retries: $owner_repo"
              
              # æ£€æŸ¥åŸå§‹ä»“åº“æ˜¯å¦å­˜åœ¨ï¼ˆæ·»åŠ è¶…æ—¶ï¼‰
              if timeout 30 gh repo view "$owner_repo" --json name >/dev/null 2>&1; then
                echo "âœ… åŸå§‹ä»“åº“å­˜åœ¨: $owner_repo"
                break
              else
                if [ $retry_count -eq $((max_retries - 1)) ]; then
                  echo "âŒ åŸå§‹ä»“åº“ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®: $owner_repo"
                  status="not_found"
                  message="åŸå§‹ä»“åº“ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—®"
                  error_occurred=true
                else
                  echo "â³ é‡è¯•ä¸­..."
                  sleep 5
                fi
                retry_count=$((retry_count + 1))
              fi
            done
            
            # å¦‚æœåŸå§‹ä»“åº“ä¸å­˜åœ¨ï¼Œä¿å­˜ç»“æœå¹¶ç»§ç»­ä¸‹ä¸€ä¸ª
            if [ "$error_occurred" = "true" ]; then
              jq -n \
                --arg repo "$owner_repo" \
                --arg owner "$owner" \
                --arg repo_name "$repo" \
                --arg status "$status" \
                --arg message "$message" \
                --arg my_fork "unknown/$repo" \
                --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                '{
                  repo: $repo,
                  owner: $owner,
                  repo_name: $repo_name,
                  status: $status,
                  message: $message,
                  my_fork: $my_fork,
                  timestamp: $timestamp
                }' > "results/${owner}_${repo}.json"
              
              sleep 2  # çŸ­æš‚å»¶è¿Ÿåç»§ç»­
              continue
            fi
            
            # è·å–å½“å‰ç”¨æˆ·ä¿¡æ¯
            my_login=""
            retry_count=0
            while [ $retry_count -lt $max_retries ] && [ -z "$my_login" ]; do
              my_login=$(timeout 15 gh api user --jq .login 2>/dev/null || echo "")
              if [ -z "$my_login" ]; then
                echo "â³ è·å–ç”¨æˆ·ä¿¡æ¯é‡è¯•ä¸­..."
                sleep 3
                retry_count=$((retry_count + 1))
              fi
            done
            
            if [ -z "$my_login" ]; then
              echo "âŒ æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯: $owner_repo"
              status="auth_failed"
              message="æ— æ³•è·å–ç”¨æˆ·ä¿¡æ¯"
              
              jq -n \
                --arg repo "$owner_repo" \
                --arg owner "$owner" \
                --arg repo_name "$repo" \
                --arg status "$status" \
                --arg message "$message" \
                --arg my_fork "unknown/$repo" \
                --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
                '{
                  repo: $repo,
                  owner: $owner,
                  repo_name: $repo_name,
                  status: $status,
                  message: $message,
                  my_fork: $my_fork,
                  timestamp: $timestamp
                }' > "results/${owner}_${repo}.json"
              
              sleep 2
              continue
            fi
            
            my_fork="${my_login}/$repo"
            
            # å¢å¼ºçš„forkçŠ¶æ€æ£€æŸ¥ï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
            fork_exists=false
            fork_status="unknown"
            
            # æ£€æŸ¥æˆ‘çš„forkæ˜¯å¦å­˜åœ¨ï¼ˆæ·»åŠ è¶…æ—¶å’Œé”™è¯¯å¤„ç†ï¼‰
            repo_check_result=""
            retry_count=0
            while [ $retry_count -lt $max_retries ]; do
              repo_check_result=$(timeout 30 gh repo view "$my_fork" --json name,parent,isFork,nameWithOwner 2>/dev/null || echo "ERROR")
              if [ "$repo_check_result" != "ERROR" ] && [ -n "$repo_check_result" ]; then
                break
              else
                echo "â³ æ£€æŸ¥forkçŠ¶æ€é‡è¯•ä¸­..."
                sleep 3
                retry_count=$((retry_count + 1))
              fi
            done
            
            if [ "$repo_check_result" != "ERROR" ] && [ -n "$repo_check_result" ]; then
              # è§£æä»“åº“ä¿¡æ¯
              is_fork=$(echo "$repo_check_result" | jq -r '.isFork // false' 2>/dev/null || echo "false")
              parent_name=$(echo "$repo_check_result" | jq -r '.parent.nameWithOwner // empty' 2>/dev/null || echo "")
              
              echo "ğŸ” æ£€æŸ¥forkçŠ¶æ€: is_fork=$is_fork, parent=$parent_name"
              
              if [ "$is_fork" = "true" ]; then
                if [ -n "$parent_name" ] && [ "$parent_name" = "$owner_repo" ]; then
                  # å®Œç¾åŒ¹é…çš„fork
                  fork_exists=true
                  fork_status="valid_fork"
                  echo "âœ… å·²forkä¸”parentåŒ¹é…: $my_fork <- $owner_repo"
                elif [ -n "$parent_name" ]; then
                  # forkä½†parentä¸åŒ¹é…
                  fork_exists=false
                  fork_status="wrong_parent"
                  echo "âš ï¸  å·²forkä½†parentä¸åŒ¹é…: $my_fork (parent: $parent_name, expected: $owner_repo)"
                else
                  # forkä½†æ²¡æœ‰parentä¿¡æ¯ï¼Œä½¿ç”¨APIæ£€æŸ¥
                  echo "ğŸ” Forkæ— parentä¿¡æ¯ï¼Œå°è¯•APIæ£€æŸ¥..."
                  
                  api_info=""
                  retry_count=0
                  while [ $retry_count -lt $max_retries ]; do
                    api_info=$(timeout 20 gh api repos/"$my_fork" --jq '{fork: .fork, parent: .parent.full_name}' 2>/dev/null || echo "ERROR")
                    if [ "$api_info" != "ERROR" ]; then
                      break
                    else
                      echo "â³ APIæ£€æŸ¥é‡è¯•ä¸­..."
                      sleep 3
                      retry_count=$((retry_count + 1))
                    fi
                  done
                  
                  if [ "$api_info" != "ERROR" ]; then
                    api_parent=$(echo "$api_info" | jq -r '.parent // empty' 2>/dev/null || echo "")
                    
                    if [ -n "$api_parent" ] && [ "$api_parent" = "$owner_repo" ]; then
                      fork_exists=true
                      fork_status="valid_fork_api"
                      echo "âœ… APIç¡®è®¤ä¸ºæ­£ç¡®çš„fork: $my_fork <- $api_parent"
                    else
                      fork_exists=false
                      fork_status="invalid_fork"
                      echo "âŒ APIæ£€æŸ¥æ— æ³•ç¡®è®¤ä¸ºæœ‰æ•ˆfork"
                    fi
                  else
                    fork_exists=false
                    fork_status="api_check_failed"
                    echo "âŒ APIæ£€æŸ¥å¤±è´¥"
                  fi
                fi
              else
                # ä¸æ˜¯forkï¼Œæ˜¯åŒåçš„ç‹¬ç«‹ä»“åº“
                fork_exists=false
                fork_status="independent_repo"
                echo "âš ï¸  ä»“åº“ $my_fork å­˜åœ¨ä½†ä¸æ˜¯fork (ç‹¬ç«‹ä»“åº“)"
              fi
            else
              # forkä¸å­˜åœ¨
              fork_exists=false
              fork_status="not_exists"
              echo "ğŸ†• å°šæœªfork: $owner_repo"
            fi
            
            # æ ¹æ®æƒ…å†µæ‰§è¡Œæ“ä½œï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
            if [ "${{ inputs.dry_run }}" = "true" ]; then
              # è¯•è¿è¡Œæ¨¡å¼
              if [ "$fork_exists" = "false" ]; then
                if [ "$fork_status" = "wrong_parent" ] || [ "$fork_status" = "independent_repo" ]; then
                  status="conflict_detected"
                  message="æ£€æµ‹åˆ°åŒåä»“åº“å†²çªï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†"
                else
                  status="will_fork"
                  message="å°†ä¼šfork"
                fi
              else
                status="will_sync"
                message="å·²forkï¼Œéœ€è¦æ—¶ä¼šåŒæ­¥"
              fi
            elif [ "$fork_exists" = "false" ]; then
              # éœ€è¦fork
              if [ "$fork_status" = "wrong_parent" ] || [ "$fork_status" = "independent_repo" ]; then
                # å­˜åœ¨å†²çªï¼Œè·³è¿‡
                echo "âš ï¸  è·³è¿‡forkï¼Œå­˜åœ¨åŒåä»“åº“: $my_fork"
                status="skipped_conflict"
                message="è·³è¿‡ï¼šå­˜åœ¨åŒåä»“åº“å†²çª"
              else
                # æ­£å¸¸forkï¼ˆæ·»åŠ é”™è¯¯å¤„ç†å’Œè¶…æ—¶ï¼‰
                echo "ğŸ´ æ­£åœ¨fork: $owner_repo"
                
                fork_output=""
                fork_exit_code=1
                retry_count=0
                
                while [ $retry_count -lt $max_retries ] && [ $fork_exit_code -ne 0 ]; do
                  echo "ğŸ”„ Forkå°è¯• $((retry_count + 1))/$max_retries"
                  fork_output=$(timeout 60 gh repo fork "$owner_repo" --clone=false 2>&1)
                  fork_exit_code=$?
                  
                  if [ $fork_exit_code -eq 0 ]; then
                    echo "âœ… ForkæˆåŠŸ: $owner_repo"
                    status="forked"
                    message="æ–°forkæˆåŠŸ"
                    break
                  else
                    # æ£€æŸ¥æ˜¯å¦æ˜¯"already exists"é”™è¯¯
                    if echo "$fork_output" | grep -q "already exists"; then
                      echo "â„¹ï¸  Forkå·²å­˜åœ¨ï¼Œæ£€æŸ¥çŠ¶æ€: $my_fork"
                      status="already_forked"
                      message="Forkå·²å­˜åœ¨"
                      fork_exists=true
                      break
                    else
                      if [ $retry_count -eq $((max_retries - 1)) ]; then
                        echo "âŒ Forkå¤±è´¥: $owner_repo"
                        echo "é”™è¯¯è¾“å‡º: $fork_output"
                        status="fork_failed"
                        message="Forkå¤±è´¥: $(echo "$fork_output" | head -1 | cut -c1-50)"
                      else
                        echo "â³ Forké‡è¯•ä¸­..."
                        sleep 5
                      fi
                      retry_count=$((retry_count + 1))
                    fi
                  fi
                done
              fi
            else
              # å·²forkï¼Œæ‰§è¡ŒåŒæ­¥ï¼ˆæ·»åŠ é”™è¯¯å¤„ç†ï¼‰
              echo "ğŸ”„ æ­£åœ¨åŒæ­¥fork: $my_fork"
              
              sync_needed=false
              if [ "${{ inputs.force_sync }}" = "true" ] || [ "${{ github.event_name }}" = "schedule" ]; then
                sync_needed=true
                echo "ğŸ”„ å¼ºåˆ¶åŒæ­¥æ¨¡å¼"
              fi
              
              if [ "$sync_needed" = "true" ]; then
                # æ‰§è¡ŒåŒæ­¥ï¼ˆæ·»åŠ è¶…æ—¶å’Œé‡è¯•ï¼‰
                sync_output=""
                sync_exit_code=1
                retry_count=0
                
                while [ $retry_count -lt $max_retries ] && [ $sync_exit_code -ne 0 ]; do
                  echo "ğŸ”„ åŒæ­¥å°è¯• $((retry_count + 1))/$max_retries"
                  sync_output=$(timeout 120 gh repo sync "$my_fork" --source "$owner_repo" 2>&1)
                  sync_exit_code=$?
                  
                  if [ $sync_exit_code -eq 0 ]; then
                    echo "âœ… åŒæ­¥æˆåŠŸ: $my_fork"
                    status="synced"
                    message="åŒæ­¥æˆåŠŸ"
                    break
                  else
                    # æ£€æŸ¥åŒæ­¥å¤±è´¥çš„åŸå› 
                    if echo "$sync_output" | grep -q "up to date\|already up-to-date"; then
                      echo "â„¹ï¸  å·²æ˜¯æœ€æ–°: $my_fork"
                      status="up_to_date"
                      message="å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
                      break
                    else
                      if [ $retry_count -eq $((max_retries - 1)) ]; then
                        echo "âš ï¸  åŒæ­¥å¤±è´¥: $my_fork"
                        echo "é”™è¯¯è¾“å‡º: $sync_output"
                        status="sync_failed"
                        message="åŒæ­¥å¤±è´¥: $(echo "$sync_output" | head -1 | cut -c1-50)"
                      else
                        echo "â³ åŒæ­¥é‡è¯•ä¸­..."
                        sleep 10
                      fi
                      retry_count=$((retry_count + 1))
                    fi
                  fi
                done
              else
                # éå¼ºåˆ¶æ¨¡å¼ï¼Œç®€å•æ£€æŸ¥
                echo "ğŸ” æ£€æŸ¥æ˜¯å¦éœ€è¦åŒæ­¥..."
                if timeout 60 gh repo sync "$my_fork" --source "$owner_repo" 2>/dev/null; then
                  echo "âœ… åŒæ­¥æˆåŠŸ: $my_fork"
                  status="synced"
                  message="è‡ªåŠ¨åŒæ­¥æˆåŠŸ"
                else
                  echo "â„¹ï¸  æ— éœ€åŒæ­¥æˆ–åŒæ­¥å¤±è´¥: $my_fork"
                  status="up_to_date"
                  message="å·²æ˜¯æœ€æ–°æˆ–æ— éœ€åŒæ­¥"
                fi
              fi
            fi
            
            # ä¿å­˜ç»“æœï¼ˆç¡®ä¿ç›®å½•å­˜åœ¨ï¼‰
            mkdir -p "results"
            jq -n \
              --arg repo "$owner_repo" \
              --arg owner "$owner" \
              --arg repo_name "$repo" \
              --arg status "$status" \
              --arg message "$message" \
              --arg my_fork "$my_fork" \
              --arg fork_status "$fork_status" \
              --arg timestamp "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
              '{
                repo: $repo,
                owner: $owner,
                repo_name: $repo_name,
                status: $status,
                message: $message,
                my_fork: $my_fork,
                fork_status: $fork_status,
                timestamp: $timestamp
              }' > "results/${owner}_${repo}.json" 2>/dev/null || {
                echo "âš ï¸  ä¿å­˜ç»“æœæ–‡ä»¶å¤±è´¥: ${owner}_${repo}.json"
              }
            
            # é˜²æ­¢rate limit - æ¯ä¸ªä»“åº“ä¹‹é—´å»¶è¿Ÿ
            echo "â±ï¸  ç­‰å¾… 5 ç§’..."
            sleep 5
          done
          
          echo "âœ… æ‰¹æ¬¡ ${{ matrix.batch.batch_id }} å¤„ç†å®Œæˆ"
          
          # é‡æ–°å¯ç”¨é”™è¯¯é€€å‡º
          set -e
          
      - name: Upload batch results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: batch-results-${{ matrix.batch.batch_id }}
          path: results/
          retention-days: 7

  collect-results:
    runs-on: ubuntu-latest
    needs: [prepare, create-batches, fork-sync]
    if: always() && needs.prepare.outputs.total_count > 0
    steps:
      - name: Download all batch results
        uses: actions/download-artifact@v4
        with:
          pattern: batch-results-*
          path: all-results/
          merge-multiple: true

      - name: Generate results table
        run: |
          echo "ğŸ“Š æ­£åœ¨ç”Ÿæˆç»“æœè¡¨æ ¼..."
          
          # åˆ›å»ºç»“æœæ±‡æ€»
          echo "# ğŸ¯ AstrBotæ’ä»¶Fork/Syncç»“æœæŠ¥å‘Š" > results_summary.md
          echo "" >> results_summary.md
          echo "**æ“ä½œæ—¶é—´:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> results_summary.md
          echo "**æ“ä½œæ¨¡å¼:** ${{ inputs.dry_run && 'ğŸ” è¯•è¿è¡Œ' || 'â–¶ï¸ å®é™…æ‰§è¡Œ' }}" >> results_summary.md
          echo "**æ€»ä»“åº“æ•°:** ${{ needs.prepare.outputs.total_count }}" >> results_summary.md
          echo "" >> results_summary.md
          
          # ç»Ÿè®¡å„ç§çŠ¶æ€
          total=0
          forked=0
          synced=0
          up_to_date=0
          already_forked=0
          failed=0
          not_found=0
          conflicts=0
          
          # åˆ›å»ºè¡¨æ ¼å¤´
          echo "## ğŸ“‹ è¯¦ç»†ç»“æœ" >> results_summary.md
          echo "" >> results_summary.md
          echo "| ä»“åº“ | çŠ¶æ€ | æˆ‘çš„Fork | è¯´æ˜ | ForkçŠ¶æ€ | æ—¶é—´ |" >> results_summary.md
          echo "|------|------|----------|------|----------|------|" >> results_summary.md
          
          # å¤„ç†æ‰€æœ‰ç»“æœæ–‡ä»¶
          if [ -d "all-results" ]; then
            for file in all-results/*.json; do
              if [ -f "$file" ]; then
                total=$((total + 1))
                
                # æå–æ•°æ®
                repo=$(jq -r '.repo' "$file" 2>/dev/null || echo "unknown")
                status=$(jq -r '.status' "$file" 2>/dev/null || echo "unknown")
                message=$(jq -r '.message' "$file" 2>/dev/null || echo "æ— æ¶ˆæ¯")
                my_fork=$(jq -r '.my_fork' "$file" 2>/dev/null || echo "unknown")
                fork_status=$(jq -r '.fork_status // "unknown"' "$file" 2>/dev/null || echo "unknown")
                timestamp=$(jq -r '.timestamp' "$file" 2>/dev/null || echo "$(date -u +%Y-%m-%dT%H:%M:%SZ)")
                
                # æ ¼å¼åŒ–æ—¶é—´
                formatted_time=$(date -d "$timestamp" '+%H:%M' 2>/dev/null || echo "N/A")
                
                # çŠ¶æ€å›¾æ ‡å’Œç»Ÿè®¡
                case "$status" in
                  "forked")
                    icon="ğŸ´"
                    forked=$((forked + 1))
                    ;;
                  "synced")
                    icon="ğŸ”„"
                    synced=$((synced + 1))
                    ;;
                  "up_to_date")
                    icon="âœ…"
                    up_to_date=$((up_to_date + 1))
                    ;;
                  "already_forked")
                    icon="ğŸ“"
                    already_forked=$((already_forked + 1))
                    ;;
                  "fork_failed"|"sync_failed"|"auth_failed"|"api_check_failed")
                    icon="âŒ"
                    failed=$((failed + 1))
                    ;;
                  "not_found")
                    icon="ğŸš«"
                    not_found=$((not_found + 1))
                    ;;
                  "skipped_conflict"|"fork_conflict"|"conflict_detected")
                    icon="âš ï¸"
                    conflicts=$((conflicts + 1))
                    ;;
                  "will_fork")
                    icon="ğŸ”®"
                    ;;
                  "will_sync")
                    icon="ğŸ”®"
                    ;;
                  *)
                    icon="â“"
                    ;;
                esac
                
                # æ ¼å¼åŒ–forkçŠ¶æ€
                case "$fork_status" in
                  "valid_fork"|"valid_fork_api") fork_status_display="âœ… æœ‰æ•ˆ" ;;
                  "wrong_parent") fork_status_display="âš ï¸ é”™è¯¯çˆ¶çº§" ;;
                  "independent_repo") fork_status_display="ğŸ  ç‹¬ç«‹ä»“åº“" ;;
                  "not_exists") fork_status_display="âŒ ä¸å­˜åœ¨" ;;
                  "invalid_fork") fork_status_display="âŒ æ— æ•ˆfork" ;;
                  "api_check_failed") fork_status_display="âŒ APIæ£€æŸ¥å¤±è´¥" ;;
                  *) fork_status_display="â“ æœªçŸ¥" ;;
                esac
                
                # æ·»åŠ åˆ°è¡¨æ ¼
                echo "| [\`$repo\`](https://github.com/$repo) | $icon $message | [\`$my_fork\`](https://github.com/$my_fork) | $message | $fork_status_display | $formatted_time |" >> results_summary.md
              fi
            done
          fi
          
          # æ·»åŠ ç»Ÿè®¡æ‘˜è¦
          echo "" >> results_summary.md
          echo "## ğŸ“Š ç»Ÿè®¡æ‘˜è¦" >> results_summary.md
          echo "" >> results_summary.md
          echo "| çŠ¶æ€ | æ•°é‡ | ç™¾åˆ†æ¯” |" >> results_summary.md
          echo "|------|------|--------|" >> results_summary.md
          
          if [ $total -gt 0 ]; then
            [ $forked -gt 0 ] && echo "| ğŸ´ æ–°forkæˆåŠŸ | $forked | $(( forked * 100 / total ))% |" >> results_summary.md
            [ $synced -gt 0 ] && echo "| ğŸ”„ åŒæ­¥æˆåŠŸ | $synced | $(( synced * 100 / total ))% |" >> results_summary.md
            [ $up_to_date -gt 0 ] && echo "| âœ… å·²æ˜¯æœ€æ–° | $up_to_date | $(( up_to_date * 100 / total ))% |" >> results_summary.md
            [ $already_forked -gt 0 ] && echo "| ğŸ“ å·²fork(æœªåŒæ­¥) | $already_forked | $(( already_forked * 100 / total ))% |" >> results_summary.md
            [ $conflicts -gt 0 ] && echo "| âš ï¸ å†²çª/è·³è¿‡ | $conflicts | $(( conflicts * 100 / total ))% |" >> results_summary.md
            [ $failed -gt 0 ] && echo "| âŒ å¤±è´¥ | $failed | $(( failed * 100 / total ))% |" >> results_summary.md
            [ $not_found -gt 0 ] && echo "| ğŸš« ä»“åº“ä¸å­˜åœ¨ | $not_found | $(( not_found * 100 / total ))% |" >> results_summary.md
          fi
          
          echo "" >> results_summary.md
          echo "**æ€»è®¡:** $total ä¸ªä»“åº“" >> results_summary.md
          
          # æ·»åŠ å»ºè®®
          echo "" >> results_summary.md
          echo "## ğŸ’¡ å»ºè®®" >> results_summary.md
          echo "" >> results_summary.md
          if [ $failed -gt 0 ]; then
            echo "- âš ï¸  æœ‰ $failed ä¸ªä»“åº“æ“ä½œå¤±è´¥ï¼Œå»ºè®®æ£€æŸ¥æƒé™æˆ–ç½‘ç»œé—®é¢˜" >> results_summary.md
          fi
          if [ $conflicts -gt 0 ]; then
            echo "- âš ï¸  æœ‰ $conflicts ä¸ªä»“åº“å­˜åœ¨å†²çªï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†åŒåä»“åº“" >> results_summary.md
          fi
          if [ $not_found -gt 0 ]; then
            echo "- ğŸ” æœ‰ $not_found ä¸ªä»“åº“ä¸å­˜åœ¨ï¼Œå¯èƒ½å·²è¢«åˆ é™¤æˆ–ç§»åŠ¨" >> results_summary.md
          fi
          if [ $already_forked -gt 0 ]; then
            echo "- ğŸ”„ æœ‰ $already_forked ä¸ªå·²forkä»“åº“æœªåŒæ­¥ï¼Œå¯ä½¿ç”¨'å¼ºåˆ¶åŒæ­¥'é€‰é¡¹æ›´æ–°" >> results_summary.md
          fi
          echo "- ğŸ“… å»ºè®®å¯ç”¨å®šæœŸåŒæ­¥ä¿æŒforkæœ€æ–°" >> results_summary.md
          echo "- ğŸ§¹ å¯¹äºå†²çªçš„ä»“åº“ï¼Œå»ºè®®æ‰‹åŠ¨æ£€æŸ¥å¹¶é‡å‘½åæˆ–åˆ é™¤" >> results_summary.md
          echo "- ğŸ”„ å¦‚æœé‡åˆ°å¤±è´¥ï¼Œå·¥ä½œæµä¼šè‡ªåŠ¨é‡è¯•ï¼Œæé«˜æˆåŠŸç‡" >> results_summary.md
          
          echo "âœ… ç»“æœè¡¨æ ¼ç”Ÿæˆå®Œæˆ"
          
      - name: Upload results summary
        uses: actions/upload-artifact@v4
        with:
          name: fork-sync-results
          path: results_summary.md
          retention-days: 30

      - name: Display results in step summary
        run: |
          echo "ğŸ“Š æ­£åœ¨æ·»åŠ ç»“æœåˆ°æ­¥éª¤æ‘˜è¦..."
          cat results_summary.md >> $GITHUB_STEP_SUMMARY

  summary:
    runs-on: ubuntu-latest
    needs: [prepare, create-batches, fork-sync, collect-results]
    if: always()
    steps:
      - name: Final summary
        run: |
          echo "# ğŸ¯ AstrBotæ’ä»¶Fork/Syncæ“ä½œå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“Š **åŸºæœ¬ä¿¡æ¯:**" >> $GITHUB_STEP_SUMMARY
          echo "- æ€»ä»“åº“æ•°: ${{ needs.prepare.outputs.total_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- æ‰¹æ¬¡æ•°é‡: ${{ needs.create-batches.outputs.batch_count }}" >> $GITHUB_STEP_SUMMARY
          echo "- æ“ä½œæ¨¡å¼: ${{ inputs.dry_run && 'ğŸ” è¯•è¿è¡Œ' || 'â–¶ï¸ å®é™…æ‰§è¡Œ' }}" >> $GITHUB_STEP_SUMMARY
          echo "- å¼ºåˆ¶åŒæ­¥: ${{ inputs.force_sync && 'âœ… æ˜¯' || 'âŒ å¦' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # æ˜¾ç¤ºå„ä¸ªjobçš„çŠ¶æ€
          echo "ğŸ”§ **ä»»åŠ¡çŠ¶æ€:**" >> $GITHUB_STEP_SUMMARY
          echo "- å‡†å¤‡é˜¶æ®µ: ${{ needs.prepare.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- æ‰¹æ¬¡åˆ›å»º: ${{ needs.create-batches.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Fork/Sync: ${{ needs.fork-sync.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ç»“æœæ”¶é›†: ${{ needs.collect-results.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.collect-results.result }}" = "success" ]; then
            echo "âœ… **è¯¦ç»†ç»“æœè¡¨æ ¼å·²ç”Ÿæˆï¼**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“‹ è¯·æŸ¥çœ‹ä¸Šæ–¹çš„ \`collect-results\` æ­¥éª¤è·å–å®Œæ•´çš„ç»“æœè¡¨æ ¼ã€‚" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ’¾ **ç»“æœæ–‡ä»¶:**" >> $GITHUB_STEP_SUMMARY
            echo "- å¯åœ¨ Artifacts ä¸­ä¸‹è½½ \`fork-sync-results\` æ–‡ä»¶æŸ¥çœ‹è¯¦ç»†æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
            echo "- åŒ…å«æ‰€æœ‰ä»“åº“çš„forkçŠ¶æ€ã€é“¾æ¥å’Œæ—¶é—´æˆ³" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸  **ç»“æœæ”¶é›†çŠ¶æ€å¼‚å¸¸**" >> $GITHUB_STEP_SUMMARY
            echo "- æ“ä½œçŠ¶æ€: ${{ needs.fork-sync.result }}" >> $GITHUB_STEP_SUMMARY
            echo "- ç»“æœæ”¶é›†: ${{ needs.collect-results.result }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ” **å¯èƒ½çš„åŸå› :**" >> $GITHUB_STEP_SUMMARY
            echo "- ç½‘ç»œè¶…æ—¶æˆ–APIé™åˆ¶" >> $GITHUB_STEP_SUMMARY
            echo "- æŸäº›ä»“åº“è®¿é—®æƒé™é—®é¢˜" >> $GITHUB_STEP_SUMMARY
            echo "- GitHub APIä¸´æ—¶ä¸å¯ç”¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”„ **æ”¹è¿›ç‰¹æ€§:**" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å¢åŠ äº†é‡è¯•æœºåˆ¶ï¼ˆæ¯ä¸ªæ“ä½œæœ€å¤šé‡è¯•3æ¬¡ï¼‰" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ·»åŠ äº†è¶…æ—¶ä¿æŠ¤ï¼Œé¿å…é•¿æ—¶é—´é˜»å¡" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… æ”¹è¿›äº†é”™è¯¯å¤„ç†ï¼Œå•ä¸ªä»“åº“å¤±è´¥ä¸å½±å“æ•´æ‰¹" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å‡å°‘äº†æ‰¹æ¬¡å¤§å°å’Œå¹¶å‘æ•°ï¼Œé™ä½APIå‹åŠ›" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… å¢åŠ äº†å»¶è¿Ÿæ—¶é—´ï¼Œæ›´å¥½åœ°é¿å…rate limit" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ”„ **ä¸‹æ¬¡è¿è¡Œå»ºè®®:**" >> $GITHUB_STEP_SUMMARY
          echo "- ä½¿ç”¨è¯•è¿è¡Œæ¨¡å¼é¢„è§ˆæ“ä½œ" >> $GITHUB_STEP_SUMMARY
          echo "- å®šæœŸè¿è¡Œä»¥ä¿æŒforkåŒæ­¥" >> $GITHUB_STEP_SUMMARY
          echo "- æ£€æŸ¥å¤±è´¥çš„ä»“åº“å¹¶æ‰‹åŠ¨å¤„ç†" >> $GITHUB_STEP_SUMMARY
          echo "- æ–°çš„é”™è¯¯å¤„ç†æœºåˆ¶æé«˜äº†ç¨³å®šæ€§" >> $GITHUB_STEP_SUMMARY
